<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8" />
    <title th:text="'문서 수정 - ' + ${slug}">문서 수정</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>

<body class="bg-light">
    <div class="container my-4" th:object="${form}">
        <h1 class="h4 mb-3">문서 수정</h1>

        <form id="editForm" th:action="@{|/docs/${slug}/edit|}" method="post" class="vstack gap-3">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <!-- 제목 / 요약 -->
            <div>
                <label class="form-label">제목</label>
                <input class="form-control" th:field="*{title}" required />
            </div>

            <div>
                <label class="form-label">요약(선택)</label>
                <textarea class="form-control" rows="2" th:field="*{summary}"></textarea>
            </div>

            <hr />

            <!-- 상단: 섹션 헤더 + 추가 버튼 -->
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 m-0">섹션</h2>
                <button type="button" id="addSection" class="btn btn-outline-primary btn-sm">섹션 추가</button>
            </div>

            <!-- 섹션 목록 -->
            <div id="sections" class="vstack gap-3">
                <!-- 기존 섹션 렌더링 -->
                <div class="border rounded p-3" th:each="s,stat : *{sections}" data-section>
                    <div class="mb-2">
                        <label class="form-label">섹션 제목</label>
                        <!-- __${stat.index}__ 를 써야 name에 인덱스가 정확히 들어갑니다 -->
                        <input class="form-control" th:field="*{sections[__${stat.index}__].heading}" />
                    </div>
                    <div>
                        <label class="form-label">내용</label>
                        <textarea class="form-control" rows="6"
                            th:field="*{sections[__${stat.index}__].contentMd}"></textarea>
                    </div>
                    <div class="text-end mt-2">
                        <button type="button" class="btn btn-outline-danger btn-sm removeSection">섹션 삭제</button>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" th:href="@{'/docs/' + ${slug}}">취소</a>
                <button class="btn btn-primary" type="submit">저장</button>
            </div>
        </form>
    </div>

    <!-- 새 섹션 템플릿(클라이언트에서 인덱스 치환) -->
    <template id="sectionTemplate">
        <div class="border rounded p-3" data-section>
            <div class="mb-2">
                <label class="form-label">섹션 제목</label>
                <input class="form-control" name="sections[__idx__].heading" />
            </div>
            <div>
                <label class="form-label">내용</label>
                <textarea class="form-control" rows="6" name="sections[__idx__].contentMd"></textarea>
            </div>
            <div class="text-end mt-2">
                <button type="button" class="btn btn-outline-danger btn-sm removeSection">섹션 삭제</button>
            </div>
        </div>
    </template>

    <script>
        const sections = document.getElementById('sections');
        const tpl = document.getElementById('sectionTemplate').content;

        // 제출 전, name들을 sections[0], [1]... 로 다시 번호 맞추기
        function reindex() {
            [...sections.querySelectorAll('[data-section]')].forEach((wrap, i) => {
                wrap.querySelectorAll('input[name], textarea[name]').forEach((el) => {
                    el.name = el.name.replace(/sections\[\d+]/, `sections[${i}]`);
                    // (선택) id도 name 기반으로 정리하면 label-for 연동에 깔끔
                    if (el.id) el.id = el.name.replace(/\[|\]/g, '_');
                });
            });
        }

        // 섹션 추가
        document.getElementById('addSection').addEventListener('click', () => {
            const clone = document.importNode(tpl, true);
            const idx = sections.querySelectorAll('[data-section]').length;
            clone.querySelectorAll('input[name], textarea[name]').forEach((el) => {
                el.name = el.name.replace('__idx__', idx);
                el.id = el.name.replace(/\[|\]/g, '_');
            });
            sections.appendChild(clone);
        });

        // 섹션 삭제
        sections.addEventListener('click', (e) => {
            const btn = e.target.closest('.removeSection');
            if (!btn) return;
            btn.closest('[data-section]')?.remove();
            reindex();
        });

        // 제출 전에 인덱스 정리
        document.getElementById('editForm').addEventListener('submit', reindex);
    </script>
</body>

</html>